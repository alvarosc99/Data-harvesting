---
title: "Working Rmd"
author: '100385774'
date: "2023-03-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction and objectives

- Compare the 50 TOP GLOBAL SONGS (weekly playlist) - features: https://open.spotify.com/playlist/37i9dQZEVXbNG2KDcFcKOF?si=3a61996b79fd4698 
  + regression to see most important factors for popularity
- Compare the 50 TOP GLOBAL SONGS vs. TOP 50 SPAIN - tracks/artists differences: https://open.spotify.com/playlist/37i9dQZEVXbJwoKy8qKpHG?si=f30d324eb3434c96
- Compare 4 different countries WEEKLY TOP 50 - features: 
    - Alemania: https://open.spotify.com/playlist/37i9dQZEVXbK8BKKMArIyl?si=708f7af7c30545a4
    - Colombia: https://open.spotify.com/playlist/37i9dQZEVXbL1Fl8vdBUba?si=6c0379f1a546446c
    - USA: https://open.spotify.com/playlist/37i9dQZEVXbLp5XoPON0wI?si=d7401e8ce534406a
    - India: https://open.spotify.com/playlist/37i9dQZEVXbMWDif5SCBJq?si=becf0ad688bc4894
- Variability between GLOBAL DAILY TOP 50 in a week - tracks/artists: https://open.spotify.com/playlist/37i9dQZEVXbMDoHDwVN2tF?si=05a703094b4841be
- Genre evolution over decades - features:  
- Artist's evolution over time - features of albums: 
    - 

# Scraping

```{r}
library(tidyverse)
library(httr2)
library(httr)
library(ggplot2)
library(jsonlite)
library(xml2)

set_config(
  user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/109.0; Alvaro Sanz / 100385774@alumnos.uc3m.es")
)
```


## API authentication

### Set the credentials

```{r}
CLIENT_ID <- "d1552a9b168446f49583043fed2ae16e"
CLIENT_SECRET <- "baeda3593af24234a8aea32e5c22fa48"
```

### Setting the endpoints

```{r}

spo_gen <- "https://api.spotify.com/v1"
spo_token <- "https://accounts.spotify.com/api/token"

```

### Token try httr2

```{r}
token <- request(spo_token) %>% 
  req_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/109.0; 
                 Ãlvaro Sanz / 100385774@alumnos.uc3m.es") %>% 
  req_headers('Authorization : Basic ZDE1NTJhOWIxNjg0NDZmNDk1ODMwNDNmZWQyYWUxNmU6YmFlZGEzNTkzYWYyNDIzNGE4YWVhMzJlNWMyMmZhNDg=') %>%
  req_headers('Content-Type' = 'application/x-www-form-urlencoded') %>% 
  req_body_form(grant_type = 'client_credentials') %>% 
  req_perform()

```

### Token try httr

```{r}
token1 <-  POST("https://accounts.spotify.com/api/token",
  accept_json(),
  authenticate(CLIENT_ID, CLIENT_SECRET), 
  body = list(grant_type = 'client_credentials'),
  encode = 'form',
  verbose()
)

token1

fulltoken <-  content(token1)$access_token
```

### Exploratory analysis

Available markets example: 
```{r}

req <- request(spo_gen) %>% 
  req_auth_bearer_token(fulltoken) 

markets <- req %>% 
  req_url_path_append("markets") %>% 
  req_perform()

markets %>% 
  resp_body_json() %>% 
  as.tibble() %>% 
  unnest()

```

Track audio features for 1 song: 
https://open.spotify.com/track/7EAtJk0HzXQp2gpFeaaLzF?si=571207f1c6e043da

```{r}
features <- req %>% 
  req_url_path_append("audio-features/7EAtJk0HzXQp2gpFeaaLzF") %>% 
  req_perform()

features %>% 
  resp_body_json() %>% 
  as.tibble()
```

Track audio features for a playlist: 
https://open.spotify.com/playlist/4LcLafs4GuCeKABvRMr667?si=48fc12f25ebf4d72


```{r}

playlist <- req %>% 
  req_url_path_append("playlists/4LcLafs4GuCeKABvRMr667/tracks") %>% 
  req_perform()

resp <- playlist %>% 
  resp_body_json(simplifyVector = T)

resp$items %>% 
  select(track) %>% 
  unnest(cols = track)
```

























